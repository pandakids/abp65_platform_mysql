var FeaturesTree=function(n){return function(){function r(r){function f(){t.find(".jstree-node").each(function(){var r=n(this),o=r.find(".jstree-anchor"),t=JSON.parse(r.attr("data-feature")),s=r.attr("data-feature-value"),f,i,e;if(t&&t.inputType&&t.inputType.name!="CHECKBOX")if(t.inputType.name=="SINGLE_LINE_STRING"){if(!r.find(".feature-tree-textbox").length){o.find(".jstree-checkbox").hide();f="text";t.inputType.validator&&t.inputType.validator.name=="NUMERIC"&&(f="number");i=n('<input class="feature-tree-textbox" type="'+f+'" />').val(s);f=="number"?(i.attr("min",t.inputType.validator.minValue),i.attr("max",t.inputType.validator.maxValue)):t.inputType.validator&&t.inputType.validator.name=="STRING"&&(t.inputType.validator.maxLength>0&&i.attr("maxlength",t.inputType.validator.maxLength),t.inputType.validator.minLength>0&&i.attr("required","required"),t.inputType.validator.regularExpression&&i.attr("pattern",t.inputType.validator.regularExpression));i.on("input propertychange paste",function(){u(t,i.val())?(r.attr("data-feature-value",i.val()),i.removeClass("feature-tree-textbox-invalid")):i.addClass("feature-tree-textbox-invalid")});i.appendTo(r)}}else t.inputType.name=="COMBOBOX"&&(r.find(".feature-tree-combobox").length||(o.find(".jstree-checkbox").hide(),e=n('<select class="feature-tree-combobox" />'),_.each(t.inputType.itemSource.items,function(t){n("<option><\/option>").attr("value",t.value).text(t.displayText).appendTo(e)}),e.val(s).on("change",function(){r.attr("data-feature-value",e.val())}).appendTo(r)))})}t=r;t.on("ready.jstree",function(){f()}).on("redraw.jstree",function(){f()}).on("after_open.jstree",function(){f()}).on("create_node.jstree",function(){f()}).on("changed.jstree",function(r,u){if(u.node){var f;u.node.state.selected?(i(t.jstree("get_parent",u.node)),f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("select_node",f)):(f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("deselect_node",f))}}).jstree({types:{"default":{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]})}function i(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&i(r)}function u(n,t){var i,r,f,u;if(!n||!n.inputType||!n.inputType.validator)return!0;if(i=n.inputType.validator,i.name=="STRING"){if(t==undefined||t==null)return i.allowNull;if(typeof t!="string"||i.minLength>0&&t.length<i.minLength||i.maxLength>0&&t.length>i.maxLength)return!1;if(i.regularExpression)return new RegExp(i.regularExpression).test(t)}else if(i.name=="NUMERIC"&&((r=parseInt(t),isNaN(r))||(f=i.minValue,f>r)||(u=i.maxValue,u>0&&r>u)))return!1;return!0}function f(){return t.find(".feature-tree-textbox-invalid").length<=0}function e(){var i=[];return t.find(".jstree-node").each(function(){var u=n(this),r=JSON.parse(u.attr("data-feature"));r.inputType&&r.inputType.name!="CHECKBOX"?i.push({name:r.name,value:u.attr("data-feature-value")}):i.push({name:r.name,value:t.jstree("is_checked",u)?"true":"false"})}),i}var t;return{init:r,getFeatureValues:e,isValid:f}}}(jQuery);(function(){app.modals.CreateOrEditEditionModal=function(){var n,r=abp.services.app.edition,t=null,i;this.init=function(r){function c(){u.find("#EditEdition_ExpireAction_AssignEdition").is(":checked")?e.slideDown("fast"):e.slideUp("fast")}function l(){u.find("#EditEdition_IsPaid").is(":checked")?(f.slideDown("fast"),h.slideDown("fast"),f.find("input").attr("required",!0)):(f.slideUp("fast"),h.slideUp("fast"),f.find("input").attr("required",!1))}function a(){u.find("#EditEdition_IsTrialActive").is(":checked")?o.slideDown("fast"):o.slideUp("fast")}function v(){u.find("#EditEdition_IsWaitingDayActive").is(":checked")?s.slideDown("fast"):s.slideUp("fast")}function w(){var n={radixPoint:".",groupSeparator:",",digits:2,autoGroup:!0,prefix:"$ ",rightAlign:!1,showMaskOnHover:!1,showMaskOnFocus:!1,placeholder:"_",removeMaskOnSubmit:!0,autoUnmask:!0};y.inputmask("numeric",$.extend({},n));p.inputmask("numeric",$.extend({},n))}var u;n=r;u=n.getModal();i=new FeaturesTree;i.init(u.find(".feature-tree"));var e=u.find(".edition-list"),f=u.find(".SubscriptionPrice"),o=u.find(".trial-day-count"),s=u.find(".waiting-day-after-expire"),h=u.find(".paid-features"),y=u.find('.paid-features > .SubscriptionPrice input[name="MonthlyPrice"]'),p=u.find('.paid-features > .SubscriptionPrice input[name="AnnualPrice"]');u.find("input[name=ExpireAction]").change(function(){c()});u.find("input[name=SubscriptionPrice]").change(function(){l()});u.find("#EditEdition_IsTrialActive").change(function(){a()});u.find("#EditEdition_IsWaitingDayActive").change(function(){v()});c();l();a();v();w();t=n.getModal().find("form[name=EditionInformationsForm]");t.validate()};this.save=function(){if(t.valid()){if(!i.isValid()){abp.message.warn(app.localize("InvalidFeaturesWarning"));return}var u=t.serializeFormToObject();n.setBusy(!0);r.createEdition({edition:u,featureValues:i.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));n.close();abp.event.trigger("app.createOrEditEditionModalSaved")}).always(function(){n.setBusy(!1)})}}}})(),function(){app.modals.CreateOrEditEditionModal=function(){var n,r=abp.services.app.edition,t=null,i;this.init=function(r){n=r;var u=n.getModal();i=new FeaturesTree;i.init(u.find(".feature-tree"));t=n.getModal().find("form[name=EditionInformationsForm]");t.validate()};this.save=function(){if(t.valid()){if(!i.isValid()){abp.message.warn(app.localize("InvalidFeaturesWarning"));return}var u=t.serializeFormToObject();n.setBusy(!0);r.updateEdition({edition:u,featureValues:i.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));n.close();abp.event.trigger("app.createOrEditEditionModalSaved")}).always(function(){n.setBusy(!1)})}}}}(),function(){$(function(){function s(n){abp.message.confirm(app.localize("EditionDeleteWarningMessage",n.displayName),app.localize("AreYouSure"),function(i){i&&t.deleteEdition({id:n.id}).done(function(){r();abp.notify.success(app.localize("SuccessfullyDeleted"))})})}function r(){i.ajax.reload()}var u=$("#EditionsTable"),t=abp.services.app.edition,n={create:abp.auth.hasPermission("Pages.Editions.Create"),edit:abp.auth.hasPermission("Pages.Editions.Edit"),"delete":abp.auth.hasPermission("Pages.Editions.Delete"),moveTenantsToAnotherEdition:abp.auth.hasPermission("Pages.Editions.MoveTenantsToAnotherEdition")},f=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Editions/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Editions/_CreateModal.js",modalClass:"CreateOrEditEditionModal"}),e=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Editions/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Editions/_EditModal.js",modalClass:"CreateOrEditEditionModal"}),o=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Editions/MoveTenantsToAnotherEdition",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Editions/_MoveTenantsToAnotherEditionModal.js",modalClass:"MoveTenantsToAnotherEditionModal"}),i;$("#CreateNewEditionButton").click(function(){f.open()});abp.event.on("app.createOrEditEditionModalSaved",function(){r()});i=u.DataTable({paging:!1,listAction:{ajaxFunction:t.getEditions},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"><\/i> '+app.localize("Actions")+' <span class="caret"><\/span>',items:[{text:app.localize("Edit"),visible:function(){return n.edit},action:function(n){e.open({id:n.record.id})}},{text:app.localize("Delete"),visible:function(){return n.delete},action:function(n){s(n.record)}},{text:app.localize("MoveTenantsToAnotherEdition"),visible:function(){return n.moveTenantsToAnotherEdition},action:function(n){o.open({id:n.record.id})}}]}},{targets:2,data:"displayName"},{targets:3,data:"price",render:function(n,t,i){return i.monthlyPrice||i.annualPrice?"$ "+i.monthlyPrice+" "+app.localize("Monthly")+" / $ "+i.annualPrice+" "+app.localize("Annual"):app.localize("Free")}},{targets:4,data:"trialDayCount",render:function(n){return n>0?app.localize("Yes")+", "+n+" "+app.localize("Days"):app.localize("No")}},{targets:5,data:"waitingDayAfterExpire"},{targets:6,data:"expiringEditionDisplayName"}]})})}();